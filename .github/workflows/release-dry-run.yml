name: Release Dry Run

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  release-dry-run:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run pre-publish checks
        run: |
          echo "Running pre-publish validation..."
          bun run type-check
          bun run test
          bun run build:lib

      - name: Test npm pack
        run: |
          echo "Testing npm package creation..."
          npm pack --dry-run

      - name: Validate package exports
        run: |
          echo "Validating package.json exports..."
          node -e "
            const pkg = require('./package.json');
            console.log('Package exports:', JSON.stringify(pkg.exports, null, 2));
            
            // Validate main exports exist
            const fs = require('fs');
            const exports = pkg.exports['.'];
            if (exports.types && !fs.existsSync(exports.types.replace('./dist/', './dist/'))) {
              console.error('Types file missing:', exports.types);
              process.exit(1);
            }
          "

      - name: Size analysis
        run: |
          echo "Analyzing bundle size..."
          if [ -f "dist/libs/components/index.mjs" ]; then
            echo "ESM bundle size:"
            ls -lh dist/libs/components/index.mjs
          fi
          if [ -f "dist/libs/components/index.cjs" ]; then
            echo "CJS bundle size:"
            ls -lh dist/libs/components/index.cjs
          fi